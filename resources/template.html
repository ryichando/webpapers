<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Title -->
		<title>{page_title}</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="{resource_dir}/bootstrap.min.css">

		<!-- Modules -->
		<script src="{resource_dir}/jquery-3.2.1.slim.min.js"></script>

		<!-- Data -->
		<script src="data.js"></script>

		<!-- Style -->
		<style>
			em {{
				display: inline-block;
				background:rgb(252, 160, 160)
			}}
		</style>
	</head>

	<body class="container-fluid">

		<div class="row m-2">
			<div class="col-1"></div>
			<div class="col text-center">
				<div class="pt-1">
					<h3>{page_title}</h3>
				</div>
				<div class="input-group" {search_hide}>
					<input type="text" class="form-control" placeholder="Type your keywords" aria-label="search keywords" aria-describedby="button-addon2" id="keywords-field">
					<div class="input-group-append" {button_hide}>
						<button type="button" class="btn btn-outline-secondary" id="search-button">Search</button>
					</div>
				</div>
			</div>
			<div class="col-1"></div>
		</div>

		<div class="row mb-2">
			<div class="col text-center">
				<div id="status"></div>
			</div>
		</div>

		<script>
			// https://stackoverflow.com/questions/4793604/how-to-insert-an-element-after-another-element-in-javascript-without-using-a-lib
			function insert_after( new_node, reference_node ) {{
				reference_node.parentNode.insertBefore(new_node, reference_node.nextSibling);
			}}
			function html_escape(str) {{
				if (!str) return;
				return str.replace(/[<>&"'`]/g, function(match) {{
					const escape_chars = {{
						'<': '&lt;',
						'>': '&gt;',
						'&': '&amp;',
						'"': '&quot;',
						"'": '&#39;',
						'`': '&#x60;'
					}};
				return escape_chars[match];
				}});
			}}
			function refresh () {{
				document.querySelectorAll('.search-result').forEach(e => e.remove());
				for (const [key, value] of Object.entries(data)) {{
					document.getElementById(value.year.toString()).hidden = false;
					document.getElementById(key).hidden = false;
				}}
			}}
			let send_search = function () {{
				$("#status").text('Processing...');
				document.querySelectorAll('.search-result').forEach(e => e.remove());
				document.getElementById("status").hidden = false;
				let keywords = $("#keywords-field").val().trim().toLowerCase().split(/-| /);
				let search_from = 'contents';
				for (const word of keywords ) {{
					if( word == 'title:' ) {{
						search_from = 'title';
						keywords.splice(keywords.indexOf('title:'),1);
						break;
					}}
				}}
				if( keywords.length == 0 || keywords[0] == "" ) {{
					refresh();
					for (const [key, value] of Object.entries(data)) {{
						document.getElementById(value.year.toString()).hidden = false;
						document.getElementById(key).hidden = false;
					}}
					document.getElementById("status").hidden = true;
					return;
				}}
				let indices = [];
				if( search_from == 'contents' ) {{
					let search_from = 'contents';
					for (const word of keywords ) {{
						if ( word in word_table ) {{
							indices.push(word_table[word])
						}} else {{
							refresh();
							$("#status").text('Not found');
							return;
						}}
					}}
				}}
				let current_year = 0;
				let year_found_count = 0;
				let num_found = 0;
				for (const [key, value] of Object.entries(data)) {{
					let year = value.year;
					if( current_year != year ) {{
						if( current_year && year_found_count == 0 ) {{
							document.getElementById(current_year.toString()).hidden = true;
						}}
						current_year = year;
						year_found_count = 0;
						document.getElementById(year.toString()).hidden = false;
					}}
					let hide = true;
					if( search_from == 'contents' ) {{
						for( let i=0; i<value.index.length; ++i ) {{
							let min = value.index[i].length;
							let max = 0;
							let window_size = 10;
							let highlights = [];
							for( const idx of indices ) {{
								let pos = -1;
								for( let j=0; j<value.index[i].length; ++j ) {{
									if( value.index[i][j][0] == idx ) {{
										pos = value.index[i][j][1];
										break;
									}}
								}}
								min = Math.min(min,pos)
								max = Math.max(max,pos)
								if( min < 0 ) break;
								highlights.push(pos);
							}}
							if( min >= 0 ) {{
								let words = html_escape(atob(value.words[i])).split(' ');
								for( const pos of highlights ) {{
									words[pos] = '<em>'+words[pos]+'</em>';
								}}
								min = Math.max(0,min-window_size);
								max = Math.min(words.length,max+window_size);
								text = words.slice(min,max).join(' ');
								if( max < words.length ) text += '...';
								hide = false;
								year_found_count += 1;
								//
								let text_row = document.createElement('div');
								text_row.className = 'row text-justify m-1 p-1 border rounded search-result';
								let text_content = document.createElement('div');
								text_content.className = 'col';
								text_content.innerHTML = text;
								text_row.appendChild(text_content);
								insert_after(text_row,document.getElementById(key))
								num_found += 1;
							}}
						}}
					}} else if ( search_from == 'title' ) {{
						let found_all = true;
						let title = document.getElementById(key+'-title').textContent.toLowerCase();
						for (const word of keywords ) {{
							if( title.indexOf(word) < 0 ) {{
								found_all = false;
								break;
							}}
						}}
						if( found_all ) {{
							num_found += 1;
							year_found_count += 1;
							hide = false;
						}}
					}}
					document.getElementById(key).hidden = hide;
				}}
				if( current_year && year_found_count == 0 ) {{
					document.getElementById(current_year.toString()).hidden = true;
				}}
				if( num_found == 1 ) {{
					$("#status").text('Found 1 occurrence.');
				}} else if( num_found > 1 ) {{ 
					$("#status").text('Found '+num_found+' occurrences.');
				}} else {{
					refresh();
					$("#status").text('Not found');
				}}
			}};
			$("#search-button").on('click', function (e) {{
				send_search();
			}});
			$("#keywords-field").on('keyup', function (e) {{
				if( {realtime_search} ) {{
					send_search();
				}} else if (e.key === 'Enter' || e.keyCode === 13) {{
					send_search();
				}}
			}});
		</script>

<script>
	//
	max_year = Math.max.apply(null,Object.keys(papers_yearly));
	min_year = Math.min.apply(null,Object.keys(papers_yearly));
	//
	for( let year=max_year; year>=min_year; --year ) {{
		if( year in papers_yearly ) {{
			//
			// Insert year header
			dirs = papers_yearly[year];
			let year_header = document.createElement('div');
			year_header.className = "row pl-4"
			year_header.style = "background-color: LightGray;";
			year_header.id = year.toString();
			year_header.innerHTML = year.toString();
			document.body.appendChild(year_header);
			//
			// For each paper
			for (const dir of dirs) {{
				//
				// Create paper row
				let paper = papers[dir];
				let paper_element = document.createElement('div'); {{
					//
					paper_element.className = "row";
					paper_element.id = dir;
					//
					// Create thumbnails
					let thumbnail_header_element = document.createElement('div'); {{
						thumbnail_header_element.className = "w-20 p-2";
						let pdf_link = document.createElement('a');
						pdf_link.href = dir+'/'+paper['pdf'];
						pdf_link.target = '_blank';
						for (const thumbnail of paper['thumbnails']) {{
							let thumbnail_img_element = document.createElement('img');
							thumbnail_img_element.src = dir+'/'+thumbnail;
							thumbnail_img_element.width = 125;
							thumbnail_img_element.height = 170;
							thumbnail_img_element.className = "border mr-1";
							pdf_link.appendChild(thumbnail_img_element);
						}}
						thumbnail_header_element.appendChild(pdf_link);
					}} paper_element.appendChild(thumbnail_header_element);
					//
					// Create body
					let body_element = document.createElement('div'); {{
						body_element.className = "col p-2 pl-3";
						//
						// Create title
						let title_element = document.createElement('div');
						title_element.innerHTML = `<h5>${{paper['title']}}</h5>`;
						body_element.appendChild(title_element);
						//
						// Create journal
						let journal_element = document.createElement('div');
						journal_element.innerHTML = `${{paper['journal']}}`;
						body_element.appendChild(journal_element);
						//
						// Create authors
						let authors_element = document.createElement('div');
						authors_element.innerHTML = `${{paper['authors']}}`;
						body_element.appendChild(authors_element);
						//
						// Create materials
						let materials_element = document.createElement('div'); {{
							materials_element.className = 'pt-3';
							//
							// video
							for (const video of paper['videos']) {{
								let video_element = document.createElement('a');
								video_element.href = dir+'/'+video;
								video_element.target = "_blank";
								video_element.style = "padding-right: 0.75rem; white-space: pre;";
								video_element.innerHTML = video.split('/').pop();
								materials_element.appendChild(video_element);
							}}
							//
							// file
							for (const file of paper['files']) {{
								let file_element = document.createElement('a');
								file_element.href = dir+'/'+file;
								file_element.target = "_blank";
								file_element.style = "padding-right: 0.75rem; white-space: pre;";
								file_element.innerHTML = file;
								materials_element.appendChild(file_element);
							}}
							//
							// [Files]
							let files_element = document.createElement('a');
							files_element.href = dir;
							files_element.target = "_blank";
							files_element.style = "padding-right: 0.75rem; white-space: pre;";
							files_element.innerHTML = "[Files]";
							materials_element.appendChild(files_element);
							//
							// [Images]
							if( 'image_page' in paper ) {{
								let images_element = document.createElement('a');
								images_element.href = dir+'/'+paper['image_page'];
								images_element.target = "_blank";
								images_element.style = "padding-right: 0.75rem; white-space: pre;";
								images_element.innerHTML = "[Images]";
								materials_element.appendChild(images_element);
							}}
						}} body_element.appendChild(materials_element);
						//
					}} paper_element.appendChild(body_element);
				}} document.body.appendChild(paper_element);
			}}
		}}
	}}
</script>

		<!-- Optional JavaScript -->
		<!-- Popper.js, then Bootstrap JS -->
		<script src="{resource_dir}/popper.min.js"></script>
		<script src="{resource_dir}/bootstrap.min.js"></script>
	</body>
</html>
